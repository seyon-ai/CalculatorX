<!DOCTYPE html>
<html>
<head>
    <title>Advanced C++/WASM Calculator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }
        .display {
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 1.8rem;
            padding: 15px;
            border-radius: 5px;
            text-align: right;
            margin-bottom: 10px;
            min-height: 70px;
            word-wrap: break-word;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        button {
            padding: 15px 5px;
            font-size: 1.2rem;
            border: none;
            border-radius: 5px;
            background: #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:active { background: #ccc; }
        .operator { background: #ffb74d; }
        .operator:active { background: #ff9800; }
        .function { background: #64b5f6; }
        .function:active { background: #42a5f5; }
        .equals { background: #66bb6a; grid-column: span 2; }
        .equals:active { background: #4caf50; }
        .clear { background: #ef5350; }
        .clear:active { background: #e53935; }
        .steps {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .graph-section {
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        .graph-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 10px;
        }
        .graph-controls input {
            flex: 1;
            min-width: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        canvas {
            width: 100%;
            height: auto;
            border: 1px solid #aaa;
            background: #fff;
        }
        .footer {
            text-align: center;
            color: #777;
            margin-top: 20px;
            font-size: 0.9rem;
        }
    </style>
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load the WebAssembly module (generated by Emscripten) -->
    <script src="calculator_engine.js"></script>
</head>
<body>
    <div class="container">
        <h1>Ultimate Complex Calculator</h1>

        <!-- Expression display -->
        <div id="display" class="display">0</div>

        <!-- Button grid -->
        <div class="buttons">
            <button class="clear" onclick="clearAll()">C</button>
            <button onclick="append('(')">(</button>
            <button onclick="append(')')">)</button>
            <button class="operator" onclick="append('^')">^</button>
            <button class="operator" onclick="append('/')">/</button>

            <button onclick="append('7')">7</button>
            <button onclick="append('8')">8</button>
            <button onclick="append('9')">9</button>
            <button class="operator" onclick="append('*')">*</button>
            <button class="function" onclick="append('sin(')">sin</button>

            <button onclick="append('4')">4</button>
            <button onclick="append('5')">5</button>
            <button onclick="append('6')">6</button>
            <button class="operator" onclick="append('-')">-</button>
            <button class="function" onclick="append('cos(')">cos</button>

            <button onclick="append('1')">1</button>
            <button onclick="append('2')">2</button>
            <button onclick="append('3')">3</button>
            <button class="operator" onclick="append('+')">+</button>
            <button class="function" onclick="append('tan(')">tan</button>

            <button onclick="append('0')">0</button>
            <button onclick="append('.')">.</button>
            <button class="function" onclick="append('pi')">π</button>
            <button class="function" onclick="append('e')">e</button>
            <button class="function" onclick="append('i')">i</button>

            <button class="equals" onclick="calculate()">=</button>
            <button class="function" onclick="append('sqrt(')">√</button>
            <button class="function" onclick="append('log(')">log</button>
            <button class="function" onclick="append('exp(')">exp</button>
            <button onclick="backspace()">⌫</button>

            <button class="function" onclick="append('asin(')">asin</button>
            <button class="function" onclick="append('acos(')">acos</button>
            <button class="function" onclick="append('atan(')">atan</button>
            <button class="function" onclick="append('abs(')">abs</button>
            <button class="function" onclick="append('fact(')">n!</button>

            <button class="function" onclick="append('pow(')">pow</button>
            <button class="function" onclick="append('hypot(')">hypot</button>
            <button class="function" onclick="append('min(')">min</button>
            <button class="function" onclick="append('max(')">max</button>
            <button class="operator" onclick="append('&&')">&&</button>
        </div>

        <!-- Steps output -->
        <div><strong>Step-by-step:</strong></div>
        <div id="steps" class="steps">Press = to see steps</div>

        <div class="steps"><strong>Pro tips:</strong> Use variables with assignment like <code>x=3+4i</code>, reuse previous result with <code>ans</code>, and build logic with <code>&&</code>, <code>||</code>, <code>!</code>.</div>

        <!-- Graphing section -->
        <div class="graph-section">
            <h3>Graph f(x)</h3>
            <div class="graph-controls">
                <input type="text" id="graphExpr" placeholder="function of x, e.g. x^2" value="x^2">
                <input type="number" id="xmin" placeholder="min x" value="-2" step="0.1">
                <input type="number" id="xmax" placeholder="max x" value="2" step="0.1">
                <input type="number" id="points" placeholder="points" value="100" min="2" max="500">
                <button onclick="plotGraph()">Plot</button>
            </div>
            <canvas id="graphCanvas"></canvas>
        </div>
        <div class="footer">Powered by C++/WebAssembly</div>
    </div>

    <script>
        // Wait for WebAssembly module to be ready
        Module.onRuntimeInitialized = function() {
            console.log("WASM module ready");
            // Optionally set a variable (like x) to a default value
            set_variable('x', 0, 0);
        };

        // C function wrappers (as defined in the engine)
        const evaluate = Module.cwrap('evaluate', 'string', ['string', 'number']);
        const steps = Module.cwrap('get_steps', 'string', []);
        const graph = Module.cwrap('graph', 'string', ['string', 'number', 'number', 'number']);
        const set_variable = Module.cwrap('set_variable', null, ['string', 'number', 'number']);
        const free_string = Module.cwrap('free_string', null, ['number']); // we don't directly use

        // Helper to free returned strings (Emscripten handles it if using 'string' return in cwrap)
        // Actually cwrap with 'string' automatically frees the memory.

        // Current expression
        let currentExpr = "";

        function append(char) {
            currentExpr += char;
            document.getElementById('display').innerText = currentExpr;
        }

        function backspace() {
            currentExpr = currentExpr.slice(0, -1);
            document.getElementById('display').innerText = currentExpr || "0";
        }

        function clearAll() {
            currentExpr = "";
            document.getElementById('display').innerText = "0";
            document.getElementById('steps').innerText = "";
        }

        function calculate() {
            if (!currentExpr) return;
            // Call evaluate with recordSteps=1
            const result = evaluate(currentExpr, 1);
            // Display result (it returns the final result string)
            document.getElementById('display').innerText = result;
            currentExpr = result;
            // Get steps and display
            const stepText = steps();
            document.getElementById('steps').innerText = stepText;
        }

        function plotGraph() {
            const expr = document.getElementById('graphExpr').value;
            const xmin = parseFloat(document.getElementById('xmin').value);
            const xmax = parseFloat(document.getElementById('xmax').value);
            const points = parseInt(document.getElementById('points').value);

            if (!expr) return;

            // Call graph function (returns JSON string of array of [x,y] points)
            const dataStr = graph(expr, xmin, xmax, points);
            let pointsArray;
            try {
                pointsArray = JSON.parse(dataStr);
            } catch (e) {
                alert("Error parsing graph data: " + dataStr);
                return;
            }

            // Extract x and y values for Chart.js
            const xs = pointsArray.map(p => p[0]);
            const ys = pointsArray.map(p => p[1]);

            // Get canvas context
            const ctx = document.getElementById('graphCanvas').getContext('2d');

            // Destroy previous chart if exists
            if (window.myChart) window.myChart.destroy();

            // Create new chart
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xs,
                    datasets: [{
                        label: expr,
                        data: ys,
                        borderColor: 'blue',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'x' } },
                        y: { title: { display: true, text: 'f(x)' } }
                    }
                }
            });
        }

        // Optional: handle keyboard input (for desktop)
        document.addEventListener('keydown', function(e) {
            const key = e.key;
            if (key >= '0' && key <= '9') append(key);
            else if (key === '+' || key === '-' || key === '*' || key === '/' || key === '^') append(key);
            else if (key === '(' || key === ')') append(key);
            else if (key === '.') append('.');
            else if (key === 'Enter') calculate();
            else if (key === 'Backspace') backspace();
            else if (key === 'Escape') clearAll();
        });
    </script>
</body>
</html>
